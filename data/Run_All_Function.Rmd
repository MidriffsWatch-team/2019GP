---
title: "MPA Model Run Clean"
author: "Seleni Cruz"
date: "December 10, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(dplyr)
library(here)
library(tidyverse)
```

#CMSY2 for 33 Genus 
```{r}
genus_catch<-read.csv(here::here("data", "function_inputs", "catch_Genus.csv"))%>%
   filter(Genus== "Atrina"
        |Genus=="Octopus"
        |Genus=="Callinectes"
        |Genus=="Scomberomorus"
        |Genus=="Epinephelus"
        |Genus=="Mugil"
        |Genus=="Panulirus"
        |Genus=="Cephalopholis"
        |Genus=="Dasyatis"
        |Genus=="Micropogonias"
        |Genus=="Caranx"
        |Genus=="Lutjanus"
        |Genus=="Squatina"
        |Genus=="Sphoeroides")

genus_priors<-read.csv(here::here("data", "function_inputs", "Genus_priors.csv"))%>%
   filter(Genus== "Atrina"
        |Genus=="Octopus"
        |Genus=="Callinectes"
        |Genus=="Scomberomorus"
        |Genus=="Epinephelus"
        |Genus=="Mugil"
        |Genus=="Panulirus"
        |Genus=="Cephalopholis"
        |Genus=="Dasyatis"
        |Genus=="Micropogonias"
        |Genus=="Caranx"
        |Genus=="Lutjanus"
        |Genus=="Squatina"
        |Genus=="Sphoeroides")

Genus<-Species_CMSY2(data=genus_catch, priors=genus_priors)
Genus_pts <- Genus[1]
Genus_ts<- Genus[2]

write.csv(Genus_pts, "Genus_pts.csv")
write.csv(Genus_ts, "Genus_ts.csv")

```


#Biologial Patch model for 14 Genus projecting 2016-2035
```{r}
pts<-read.csv(here::here("data", "Genus_pts.csv"))%>%
  select(Name, Adjusted, r, r.low, r.hi, k, k.low, k.hi, f, f_lo, f_hi, b, b_lo, b_hi, m.rate, msy, msy.low, msy.hi, bmsy, bmsy.low, bmsy.hi, fmsy, fmsy_lo, fmsy_hi)

price <- read.csv(here::here("raw_data", "MarketPrice.csv"))

data<- merge(pts, price, by="Name")%>%
  mutate (c = 0.3 * p * msy / r, 
          c.lo = 0.3 * p.lo * msy.low / r.low, 
          c.hi = 0.3 * p.hi * msy.hi / r.hi, 
          profit.msy = p * msy - (c* r), 
          profit.msy.lo = p.lo * msy.low - (c.lo * r.low),
          profit.msy.hi = p.hi * msy.hi - (c.hi * r.hi))

MPA.mat<-as.matrix(read.csv(here::here("data", "MPA.matrix.csv")))


Genus_MPA<-Biological.Model(df=data, years=50, MPA.mat = MPA.mat, MPA=1)
Genus_NO_MPA<-Biological.Model(df=data, years=50, MPA.mat = MPA.mat, MPA=0)

Genus_MPA<- Genus_MPA%>%
  mutate(Status="MPA")

Genus_NO_MPA<- Genus_NO_MPA%>%
  mutate(Status="No MPA")

Genus_patchmodel<- rbind(Genus_MPA, Genus_NO_MPA)

write.csv(Genus_patchmodel, "Genus_2D_patchmodel.csv")


```

#Merging with Catch and biomass from 2000-2015
```{r}
Genus_patchmodel

genus_ts<-read.csv(here::here("data", "Genus_ts.csv"))%>%
  select(Name, Adjusted, year, catch, b, b_lo, b_hi)%>%
  mutate(Catch_lo=NA, Catch_hi=NA, Status= "No MPA")

colnames(genus_ts)
names(genus_ts)[3:10] <- c("Year", "Catch_est", "Biomass_est", "Biomass_lo", "Biomass_hi","Catch_lo", "Catch_hi", "Status")

yearly_catch2<-genus_ts%>%
  group_by(Year, Adjusted)%>%
  summarize(Catch=sum(Catch_est))

#Biomass (est, hi and lo from CMSY2) and Catch (CONAPESCA)  from 2000-2015 
genus_ts <- genus_ts[c("Name", "Adjusted", "Year", "Biomass_est", "Biomass_lo", "Biomass_hi", "Catch_est", "Catch_lo", "Catch_hi", "Status")]

Genus_catch_biomass<- rbind(genus_ts, Genus_patchmodel)

write.csv(Genus_catch_biomass, "merged_2D_output.csv")

```



